define(["common/index"],function(r){"use strict";var s,e={},c=SFConfig,a=SFCommon,u=SFLOG,l=window.SF.resConfig,d=null,f="UI:service_init";function initService(t){return new Promise(function(n,e){var i;l.states=l.states||{init:!1,startService:!1,goDefault:!1},i=l.states,u.info(f,"init service states is "+JSON.stringify(l.states)),t.isFromService||(i.init=!1,i.startService=!1,i.goDefault=!1,s.$watch("onServiceInitLoadingClose",function(){avalon.vmodels.login&&avalon.vmodels.login.handleDialogClose()})),function _init(){return new Promise(function(o,e){i.init?o():(i.init=!0,SF.res.init({error:function(e){var o=e.message?e.message:tr("加载失败");e&&e.isLogout?a.onError({title:o,subTitle:tr("请重新登录"),btnText:tr("重新登录"),closeBtn:!1,clickAction:function(e){window.location.href="/"}}):e&&e.isEmptyData?a.onError({title:o,subTitle:tr("初始化异常，可尝试注销或关闭浏览器后重新打开"),btnText:tr("注销"),closeBtn:!1,clickAction:function(e){return new Promise(function(e,o){SFAPI.logout({byServer:!0,success:function(){window.location.href="/portal/#!/vpn_logout",is.IE(8)&&setTimeout(function(){location.reload()},300),e()},error:function(){u.error(f,"logout by server is failed","please check your network"),avalon.router.go("vpn_logout"),e()}})})}}):a.onError({title:o,subTitle:tr("请尝试刷新后重试"),btnText:tr("刷新"),closeBtn:!1,clickAction:function(e){window.location.reload()}})},onMustInstallClient:function(){r.loader.renderPlugin({name:PORTAL_MAP["other/install"],data:{isAutoClose:!0}}),n()},onCheckSecurityDeny:function(e,o){n(),r.loader.renderPlugin({name:PORTAL_MAP["other/reject_login"],data:{strategies:e,ids:o,isFromService:!!t.isFromService,checkType:"after"}})},onOtherLogin:function(){n(),avalon.router.go("vpn_openresource")},onNeedModifyPass:function(e,o){r.loader.renderPlugin({name:PORTAL_MAP["other/password_change"],data:{pwpErrorCode:o,isFromService:!0,next:function(){s.$fire("all!onShowLoading",!0),e()}}})},success:function(){var e;t.isFromService?o():(is.WebClient||(SF.windowMgr.hide(SFConfig.CONTAINER_WINDOW_ID.CURRENT_WINDOW),window.serviceStartTime=(new Date).getTime(),e=setTimeout(function(){u.info(f,"show service timeout by process"),SF.windowMgr.show(SFConfig.CONTAINER_WINDOW_ID.CURRENT_WINDOW)},11e3),SF.windowMgr.registEvents(EVENT_CLAER_SERVICE_TIMEOUT_TIMER,function(){u.info(f,"clear timer for showing service timeout"),clearTimeout(e)})),avalon.router.go("service"))}}))})}().then(function(){l.config.needGoDefault||(SFLOG.info(f,"No default resource to open, resource ready to show"),t.onRcReadyShow&&t.onRcReadyShow(),n())}).then(function _startService(){return new Promise(function(e,o){!function rewriteOnExitForDefault(){SFCommon.onExit=function(){u.debug(f,"Rewrite SFCommon.onExit to handle exit event for hide"),SF.windowMgr.hide(c.CONTAINER_WINDOW_ID.CURRENT_WINDOW)}}(),i.startService?e():(i.startService=!0,SF.res.startService({onBeforeQuery:function(){r.loader.renderPlugin({name:PORTAL_MAP["other/islogout"],data:{toggle:!1},error:function(){u.info(f,"The view of islogout is not pre-loaded")}})},onTcpFinished:t.onTcpFinished,onL3vpnFinished:t.onL3vpnFinished,onLogout:t.onLogout,onCheckSecurityDeny:function(e,o){n(),r.loader.renderPlugin({name:PORTAL_MAP["other/reject_login"],data:{strategies:e,ids:o,isFromService:!!t.isFromService,checkType:"after"}})},success:function(){is.fn(t.onServiceFinish)&&t.onServiceFinish(),e()}}))})}).then(function _goDefault(){return new Promise(function(e,o){if(SF.windowMgr.triggerEvent(EVENT_CLAER_SERVICE_TIMEOUT_TIMER,{}),i.goDefault||!l.config.needGoDefault)return u.debug(f,"Not need go default resource, skiped"),void e();i.goDefault=!0,SF.res.goDefault({onGoDefault:function(e){u.debug(f,"update loading text on go default"),d(tr("正在打开资源"))},success:function(){e()}})})}).then(function(){l.config.needGoDefault&&(SFLOG.info(f,"Default resource open finished, resource ready to show"),t.onRcReadyShow&&t.onRcReadyShow(),n()),u.info(f,"Service init finished"),t.onFinished&&t.onFinished()})["catch"](function(e){u.error(f,"catch step: proccess error  "," occur a error in proccess of start service, message is %s stack is %s ",e.message,e.stack)})})}return e.getVModelConfig=function(){return{$id:"service_init",toggle:!1,tips:"loading....",$onRendered:function(o){u.debug(f,"service_init model rendered success"),function rewriteOnExitForLoading(){SFCommon.onExit=function(){u.debug(f,"Rewrite SFCommon.onExit to handle exit event for exit"),SF.windowMgr.exit()}}(),SF.setting.setGlobal({key:KEY_GLOBAL_IS_USER_LOGOUT,value:!1},!1),avalon.vmodels.login&&(SF.auth.cancelTimer("detectKeyTimer"),avalon.vmodels.login.removeLoginWatch(),avalon.vmodels.login.loginLoading=!0),r.loader.renderPlugin({name:PORTAL_MAP["other/common_loading"],data:{isDialog:!0,tips:tr("正在加载资源"),task:function(e){return d=e,initService(o)}},success:function(){u.debug(f,"render service init success, show loading")}})}}},s=e.vmodel=avalon.define(e.getVModelConfig()),e});