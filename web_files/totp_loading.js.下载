define(["common/index"],function(o){"use strict";var n,e={},t=SFLOG,r=SFCommon,i=o.utils.isClient,a=["step2","step3"];function resetData(){n.token="",n.errorData="",n.toggle=!1,n.loading=!1,n.user="",n.secret="",n.showqrcode=!0,n.copyObj=null}return e.getVModelConfig=function(){return{$id:"totp_loading",step:0,token:"",toggle:!1,loading:!1,saveLocateRight:!1,errorData:"",finishText:tr("下一步"),cancelText:tr("上一步"),copyObj:null,copyEle:"clip",copyText:"",copyhint:"",user:"",secret:"",showqrcode:!0,autoFocus:!1,$onRendered:function(e){var t=e.auth.NextServiceData;"Bind"!==t.TotpStatus?((is.UbuntuClient||is.Mac)&&(n.saveLocateRight=!0),n.secret=t.Secret,n.user=t.User,n.copyText=n.secret,n.copyObj||(n.copyObj=new ClipBoardAdapter({handlerID:n.copyEle,isAttr:!0,type:"copy"}),n.copyObj.attach()),function createQrcode(e,t){document.getElementById(e).innerHTML="",new QRCode(e,{text:t,width:120,height:120,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H})}("qrcode_container",function createTotpURL(e){var t,o,n={PERIOD:e.Period,DIGITS:e.Digits,ALGORITHM:e.Algorithm,SECRET:e.Secret,USER:e.User};for(t in o="otpauth://totp/USER?secret=SECRET&algorithm=ALGORITHM&digits=DIGITS&period=PERIOD",n)n.hasOwnProperty(t)&&(o=o.replace(t,n[t]));return e.isuser&&(o+="&issuer="+e.issuer),o}(t)),n.step=1,n.finishText=tr("下一步"),n.cancelText=tr("上一步"),n.copyhint=tr("点击复制"),n.errorData="",n.token="",n.reDrawElList(a),n.toggle=!0,n.showqrcode=!0):o.loader.renderPlugin({name:PORTAL_MAP["totp/signature"],data:{allowRebind:!(!t.AllowRebind||"0"===t.AllowRebind)&&t.AllowRebind}})},nextStep:function(){if(1===n.step||2===n.step)return n.step=n.step<3?n.step+1:3,n.finishText=3===n.step?tr("确定"):tr("下一步"),n.reDrawElList(a),n.autoFocus=!1,void(n.autoFocus=!0);3===n.step&&(n.loading=!0,n.loginTotp())},onSubmit:function(){n.nextStep()},preStep:function(){n.step=1<n.step?n.step-1:1,3!==n.step&&(n.finishText=tr("下一步")),n.reDrawElList(a)},loginTotp:function(){if(n.errorData="",8<n.token.length||n.token.length<6)return n.errorData=tr("动态口令错误"),void(n.loading=!1);n.loading=!0,SFAPI.loginTotp({token:n.token,success:function(e){t.info("ui:totp_loading","loginTotp success"),resetData(),o.auth.codeHandler(e,{success:function(){resetData()},error:function(){n.loading=!1}})},error:function(e){n.loading=!1,n.errorData=SFCommon.getMessage(e.code)}})},reDrawEl:function(e){var t=document.getElementById(e),o=t.className;is.IE(8)&&(t.className=o+" content-empty",setTimeout(function(){t.className=o},0))},reDrawElList:function(e){var t;for(t in e)e.hasOwnProperty(t)&&n.reDrawEl(e[t])},openHelp:function(){var e="/com/help/#totp";"en_US"===SF.setting.getGlobal(KEY_GLOBAL_LANG,"")&&(e="/com/help_en/#totp"),i&&(e=location.origin+e),r.openWindow({url:e})},toggleBindWay:function(){n.showqrcode=!n.showqrcode}}},n=e.vmodel=avalon.define(e.getVModelConfig()),e});