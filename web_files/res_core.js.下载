!function(e){"use strict";var c,a=SFAPI,u=SFLOG,f=SFCommon,g=SF.rc.utils,l=SF.rc.store,o=SF.rc.opener,d={},i={success:function(){},error:function(){}},h=SFConfig,p=SF.rc.define.rcType,S={info:{},config:{unAuthData:[],securityStrategy:[],securityStrategyHash:[],enableSslTray:0,autoStartClient:0,securityCheckInterval:null,enableSecurityCheck:null,isEnableComFirstDns:"",isDisplayHost:null,needGoDefault:null,otherLogin:!1,sslvpnNameFix:"",webvpn:{}},websso:[],rc:{userBind:[],fileLock:[],unAuth:[],strategyData:[],config:{},other:{}},sso:{raw:{},data:[],info:{cert:null}}},y="business: res",s=SFConfig.container===SFConfig.CLIENT_TYPE.WEB;function Res(){}function _hideMainWindow(){SF.windowMgr.hide(SFConfig.CONTAINER_WINDOW_ID.CURRENT_WINDOW)}function _getConfigValue(e,n){var t=S.config.raw.Conf;return g.getNodeValue(e,n,t)}function _initServiceState(e){S.info.isFirstL3vpn=e.l3vpn!==h.SERVICE_STATE.STATUS_ALREADY_EXISTS,S.info.isL3vpnSuccess=e.l3vpn===h.SERVICE_STATE.STATUS_START_SUCCESS,S.info.isTcpSuccess=e.tcp===h.SERVICE_STATE.STATUS_START_SUCCESS}function _startEcTray(){return new Promise(function(n,t){u.info(y,"step :startEcTray "),h.isExistEC&&!is.WebClient?SF.windowMgr.isExistWin(h.CONTAINER_WINDOW_ID.STATUS_MANAGER_WINDOW,function(e){e?(u.info(y,"management page is exist,do not start again"),n()):a.startECTray({success:function(e){u.info(y,"start tray success"),n(e)},error:function(e){u.error(y,"Failed to start the tray"," network request error "),t(e)}})}):a.startECTray({success:function(e){u.info(y,"start tray success"),n(e)},error:function(e){u.error(y,"Failed to start the tray"," network request error "),t(e)}})})}function _settingServerAddr(){var e,n;return is.empty(d.vpnIP)||is.empty(d.vpnPort)?(n=f.URLParse(location.href),e=n.hostname+" "+n.port):e=d.vpnIP+" "+d.vpnPort,u.info(y,"step :set server address "),new Promise(function(n,t){SFAPI.doConfigEC({key:"S_SERVADDR",params:{address:e},success:function(e){u.info(y,"set Server Addr success "),n(e)},error:function(e){u.error(y," set server address failed "," network requset error "),t(e)}})})}function _syncBaseInfoToClient(o){return new Promise(function(e,n){var t,r=d.fromURL;if(h.isExistEC&&S.config.isFirstLogin){if(t=f.isWeb()?is.Browser():"default",SF.setting.setGlobal({key:KEY_GLOBAL_BROWSER_TYPE,value:t},0),"before"===o)return u.debug(y,"step :syncBaseInfoToClient before start service,need _settingServerAddr "),Promise.all([_settingServerAddr()]).then(function(){e()});if(!S.info.isOnlyWeb)return u.debug(y,"step :syncBaseInfoToClient after start service,need _settingBrowserType、_settingFrom、_settingServerAddr "),Promise.all([function _settingBrowserType(e){return u.info(y,"step :set browser type "),new Promise(function(n,t){if(!e||!is.set(e.browserType))return u.info(y,"settingBrowserType: check params error "," current param is invalid "),void n();SFAPI.doConfigEC({key:"S_BROWSER",params:{browserType:e.browserType},success:function(e){u.info(y,"set browser type success  "),n(e)},error:function(e){u.error(y,"set  browser type failed ","network request error "),t(e)}})})}({browserType:t}),function _settingFrom(r){return new Promise(function(n,t){var e="";if(u.info(y,"step :set from url  "),!r||!r.fromAddr)return u.warn(y,"set from url failed","settingFrom: fromURL is empty ,continue "),void n();e=h.systemType===h.CLIENT_TYPE.WINDOWS?"C_LOGINADDR":"S_LOGINADDR",SFAPI.doConfigEC({key:e,params:{vpnLine:r.fromAddr},success:function(e){u.info(y,"Set source url success"),n(e)},error:function(e){u.error(y,"Failed Set the source url"," network request error "),t(e)}})})}({fromAddr:r}),_settingServerAddr()]).then(function(){e()});e()}else e()})}function _isMustInstallClient(){return!(!(S.config.isEnableComFirstDns||S.config.enableSslvpnOnlyLine||S.config.enableSecurityCheck||l.data.hasLoadBalanceRc)||is.System().isMobile||f.isFreeMode())&&(u.info(y," must install client,can not excute next step. Data is: isEnableComFirstDns:"+S.config.isEnableComFirstDns+", enableSslvpnOnlyLine:"+S.config.enableSslvpnOnlyLine+", enableSecurityCheck:"+S.config.enableSecurityCheck+", hasLoadBalanceRc:"+l.data.hasLoadBalanceRc),!0)}Res.prototype={init:function(e){var n=this,t=null===h.isExistEC,r="";if(e=avalon.mix(i,e),is.fn(e.error)&&(n.error=e.error),c=SF.session.createInstance(),c.getTWFID(),r=function getRedirectUri(){var e;if(!SFCommon.isWeb())return;return(e=SFCommon.URLParse().params)&&e.redirect_uri}()){return/^\s*javascript:/i.test(r)?void n.error():(r=function encodeHTML(e){return String(e).replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}(r),location.replace(r))}!function _initParam(){var e,n=[];n.push(KEY_GLOBAL_TWFIDTMP),n.push(KEY_GLOBAL_EC_TOKEN),n.push(KEY_GLOBAL_FROM_URL),n.push(KEY_GLOBAL_VPN_PORT),n.push(KEY_GLOBAL_VPN_IP),n.push(KEY_GLOBAL_EC_PORT),n.push(KEY_GLOBAL_EC_GUID),n.push(KEY_GLOBAL_VPN_URL),e=SF.setting.getGlobal(n,[]),d.twfIDTmp=e[0],d.token=e[1],d.fromURL=e[2],d.vpnPort=e[3],d.vpnIP=e[4],d.port=e[5],d.guid=e[6],d.vpnURL=e[7]}(),function _checkECAgent(r){return new Promise(function(e,n){var t;u.info(y,"step : checkECAgent"),r?(u.info(y,"checkECAgent ECAgent not Exist,should be detect"),t=SF.setting.getGlobal(KEY_GLOBAL_IS_FROM_EC,0),SF.setting.setGlobal({key:KEY_GLOBAL_IS_FROM_EC,value:0},0),a.checkECAgent({longTimeout:t,success:function(){u.info(y," check EC agent success "),e()},error:function(){e()}})):(u.info(y,"  check EC agent success "),e())})}(t).then(function(){return function _initECAgent(e){return new Promise(function(n,t){u.info(y,"step : initECAgent"),h.isExistEC&&e?a.initECAgent({success:function(e){u.info(y,"init ECAgent success"),n(e)},error:function(e){u.error(y,"Failed to init ECAgent","error is %s ",f.getMessage(e.code)),t(e)}}):n()})}(t)}).then(function(){return function _checkLoginStatus(s){return new Promise(function(o,i){if(u.info(y,"step :queryLoginStatu"),!h.isExistEC)return S.config.isFirstLogin=!0,o(),!1;a.checkReLogin({success:function(e){var n,t={notLogin:0,selfLogin:1,otherLogin:2,checkOtherURL:3,checkOtherSession:4},r=c.getTWFID();if(u.info(y,"query login status"),!e||"undefined"==typeof e.code)return u.error(y,"queryLoginStatu:Query login status failed"," api returned null or error data "),i({message:"",stack:"check re-login status failed"}),!1;if(u.info(y,"step :checkReLogin "),e.code===t.notLogin)u.info(y,"first login,current status is "+e.code+" no user login"),S.config.isFirstLogin=!0,n=!0;else if(e.code===t.selfLogin)u.info(y,"relogin,current status is "+e.code+", self login"),n=!0;else if(e.code===t.otherLogin||e.code===t.checkOtherURL||e.code===t.checkOtherSession)return u.info(y,"relogin,other login,can not excute next temp（syncTWFID）,current status is  ",e.code),S.config.otherLogin=!0,s.onOtherLogin(),!1;if(n)return is.empty(r)?(u.error(y,"check base data failed","twfid data is empty"),i({isEmptyData:!0}),!1):function _syncTWFID(t){return u.info(y,"step :syncTWFID "),new Promise(function(e,n){a.setTWFID({twfID:t,isForce:!0,success:function(){u.info(y," sync twfid success "),e()},error:function(){u.error(y,"sync twfid error","network request error")}})})}(r).then(function(){o(e)})["catch"](function(e){i(e)});o(e)},error:function(e){u.error(y,"queryLoginStatu:Query login status failed"," cause by network request error "),i(e)}})})}(e)}).then(function(){return function _checkNeedModifyPass(i){return new Promise(function(e){var n,t,r,o;return n=SF.setting.getGlobal(KEY_GLOBAL_TWFID,""),u.assert(n,"sid is empty, can not compare mark of change password"),t=hex_md5(n+SFConfig.EC_MD5_SALT),r=f.getCookie(KEY_GLOBAL_NEED_CHANGE_PSW),o=f.getCookie(KEY_GLOBAL_CHANGE_PSW_RESULT),t&&t===r?is.fn(i.onNeedModifyPass)?void(is.fn(i.onNeedModifyPass)&&i.onNeedModifyPass(e,o)):(u.info(y,"Function onNeedModifyPass is not defined, resolve and continue"),void e()):(u.debug(y,"session is not matched, resolve and continue without change password"),void e())})}(e)}).then(function(){return new Promise(function(n,t){Promise.all([function _getStrategyAndResource(r){return new Promise(function(n,t){u.info(y,"step :getStrategyAndResource "),a.getStrategyAndResouceData({success:function(e){e&&e.data.conf&&e.data.rc&&e.data.rc.Resource?(u.info(y,"get strategy and resource success "),n(e)):(u.info(y,"conf or rcList is null "," token is invalid or do not set twfid to ecagent or ecagent return empty data "),r.success())},error:function(e){u.error(y,"get conf or rcList error "," network request error "),t(e)}})})}(e),function _checkProxy(e){return new Promise(function(t,n){u.info(y,"step :checkProxy "),h.isExistEC?a.checkProxy({success:function(e){var n=!1;e&&0===e.code&&"0"===e.data?(u.info(y,"enable proxy "),n=!0):u.info(y,"disable proxy"),t(e),u.info(y,"check proxy success"),S.info.isUseIeProxy=n},error:function(e){u.error(y," checkProxy: error is  "+f.getMessage(e.code),"network request error or return error code "),n(e)}}):t()})}(),_syncBaseInfoToClient("before")]).then(function(e){!function normalizeWebSsoInfo(e){if(e&&e.WebSsoInfos&&"string"==typeof e.WebSsoInfos){var n=e.WebSsoInfos;try{e.WebSsoInfos={},e.WebSsoInfos.webssoinfo=JSON.parse("["+n+"]")}catch(t){e.WebSsoInfos=n}}}(e[0].data.rc.Resource),n(e[0])})["catch"](function(e){t(e)})})}).then(function(e){return function _formatConfAndResource(s){return new Promise(function(e,n){var t,r,o,i=0;if(u.info(y,"step :formatConfAndResource  "),s.data.conf.Conf.Other.isUseIeProxy=S.info.isUseIeProxy,S.info=s.data.conf.Conf.Other,S.info.isFirstL3vpn=!0,S.config.raw=s.data.conf,l.initData(s.data.rc.Resource),S.config.enableSslTray=_getConfigValue("SysTray.enable",0),S.config.isEnableComFirstDns=""!==l.getConfig("Dns.dnsserver",""),S.config.showRc=_getConfigValue("Other.enable_cs_rc_windows",1),S.config.enableSslvpnOnlyLine=_getConfigValue("Other.sddn_enable",0),S.config.enableSecurityCheck=!!_getConfigValue("SecurityCheck",!1),S.config.securityCheckInterval=_getConfigValue("SecurityCheck.attribute.interval",0),S.config.sslvpnNameFix=function _getLocalConfigValue(e,n){var t=S.config.raw.LocalConf;return g.getNodeValue(e,n,t)}("Session.nameFix",""),S.info.loginName=_getConfigValue("Other.login_name","").toString(),SF.setting.setGlobal({key:KEY_GLOBAL_LOGIN_NAME,value:S.info.loginName},0),SF.setting.setGlobal({key:KEY_GLOBAL_SECURITY_CHECK,value:S.config.enableSecurityCheck},0),SF.setting.setGlobal({key:KEY_GLOBAL_TRAY_TYPE,value:S.config.enableSslTray},0),S.info.isReLogin=_getConfigValue("Other.isRelogin",0),S.info.lastLoginTime=_getConfigValue("Other.RelogTimeLast",0),S.info.lastLoginIp=_getConfigValue("Other.RelogIPLast",""),S.config.httpPort=_getConfigValue("WebHttpEnable.httpPort",0),S.config.enableWebHttp=_getConfigValue("WebHttpEnable.enable",0),S.config.webvpn.scheme=_getConfigValue("WebVpn.scheme","http:"),S.config.webvpn.hostname=_getConfigValue("WebVpn.hostname",""),S.config.webvpn.port=_getConfigValue("WebVpn.port","80"),r=SF.vpnInfo.createInstance(),o=r.getLoginInfo(),is.set(o.showRc)&&(S.config.showRc=o.showRc,u.debug(y,"Get showRc from pref-settings, showRc:"+S.config.showRc)),S.rc.groups=l.getGroups(),S.rc.rcs=l.getRcs(),S.rc.rcsHash=l.getRcsHash(),S.config.enableSecurityCheck)if(t=_getConfigValue("SecurityCheck.strategies.strategy"),is.array(t))for(S.config.securityStrategy=t;i<t.length;i++)S.config.securityStrategyHash[t[i].id]=t[i];else S.config.securityStrategy=[],S.config.securityStrategy.push(t),S.config.securityStrategyHash[t.id]=t;if(SF.setting.setGlobal({key:KEY_GLOBAL_SECURITY_STRATEGIES,value:S.config.securityStrategy},!1),S.info.isOnlyWeb=!(!f.isWeb()||_isMustInstallClient()||l.data.hasL3vpnRc||l.data.hasTcpRc||is.Win()&&l.data.hasAutoFillSsoRc),h.isExistEC&&S.config.isFirstLogin&&!S.info.isOnlyWeb&&is.empty(d.fromURL))return u.error(y,"check base data failed","necessary data fromURL is empty"),void n({isEmptyData:!0});l.updateRcState(p.WEB),l.updateRcState(p.IP),l.updateRcState(p.APP),u.info(y,"format conf data And resource data success "),e()})}(e)}).then(function(){return function _noticeClientConfig(){return new Promise(function(e,n){if(!h.isExistEC)return e(),!0;a.noticeClientConfig({success:function(){e()},error:function(){n({message:"",stack:"do xml config failed"})}})})}()}).then(function(){return function _securityCheck(r){return new Promise(function(n,t){if(!S.config.enableSecurityCheck)return n(),!0;a.checkSecurity({type:"after",success:function(e){f.checkObjAttrExits(e,"data.strategies")&&!is.empty(e.data.strategies)?(u.info(y,"check security failed after login"),is.fn(r)&&r(S.config.securityStrategy,e.data.strategies)):(u.info(y,"check security success after login"),n())},error:function(e){t({message:"",stack:"error request after login from ecagent"}),u.error(y,"check security failed after login,request failed",JSON.stringify(e))}})})}(e.onCheckSecurityDeny)}).then(function(){return function _initRsData(){if(u.info(y,"step : init res data "),!S.rc.rcs||!S.rc.groups)return void u.warn(y,"_initRsData(). Initialize resource data exceptions"," no resource data");S.rc.allData=S.rc.groups,S.rc.pureData=S.rc.rcs;var e=l.data.hasTcpRc,n=l.data.hasRemoteAppRc;SF.setting.setGlobal({key:KEY_GLOBAL_HAS_TCP_RESOURCE,value:e},0),SF.setting.setGlobal({key:KEY_GLOBAL_HAS_REMOTE_APP,value:n},0),u.debug(y,"initRsData: success")}(),n.rsInit=!0,function _checkMustInstallClient(t){return new Promise(function(e,n){u.info(y,"step : checkMustInstallClient "),h.isExistEC?e():_isMustInstallClient()?is.fn(t)&&t():(u.info(y," do not need install ec client ,continue next step "),e())})}(e.onMustInstallClient)}).then(function(){S.config.needGoDefault=!(!l.defaultRcID||!S.config.isFirstLogin),u.debug(y,"service init success"),e.success()})["catch"](function(e){e=e||{},u.error(y,"catch step: proccess error  "," occur a error in proccess, error: %s",JSON.stringify(e)),n.error(e)})},startService:function(t){var n=this;u.info(y,"[timecount] enter start service process"),function _startService(t){return new Promise(function(n,e){function handleStartServiceError(e){if(e&&e.data&&e.data.base===h.SERVICE_STATE.STATUS_LOGOUT)return u.info(y,"client is logout when service is starting"),t.onLogout&&t.onLogout(),!1;u.info(y,"Start service failed, resolve and continue as normal"),n()}function startService(r){return new Promise(function(n,t){u.info(y,"[timecount] step :startService "),a.startService({onBeforeQuery:r.onBeforeQuery,onTcpFinished:r.onTcpFinished,onL3vpnFinished:r.onL3vpnFinished,onStateChanged:function(e){_initServiceState(e)},success:function(e){e.data;u.info(y," start service success "),n(e)},error:function(e){r.onBeforeQuery().then(function(){u.error(y," start service error ","continue starting tray as normal ")}),u.error(y," start service error "," network request error or service do not start "),t(e)}})})}if(!h.isExistEC||S.info.isOnlyWeb)return t.onTcpFinished&&t.onTcpFinished(),t.onL3vpnFinished&&t.onL3vpnFinished(),void n();S.config.isFirstLogin?startService({onBeforeQuery:t.onBeforeQuery,onTcpFinished:t.onTcpFinished,onL3vpnFinished:t.onL3vpnFinished}).then(function(e){n()})["catch"](function(e){u.error(y,"Start service error","ECAgent api returned error result"+JSON.stringify(e)),handleStartServiceError(e)}):t.onBeforeQuery().then(function(){return function _queryService(e){return new Promise(function(n,t){u.info(y,"step :queryService "),a.queryService({onTcpFinished:e.onTcpFinished,onL3vpnFinished:e.onL3vpnFinished,onStateChanged:function(e){_initServiceState(e)},success:function(e){u.info(y," query service success "),n(e)},error:function(e){u.error(y," query service error "," network request error or service do not query "),t(e)}})})}({onTcpFinished:t.onTcpFinished,onL3vpnFinished:t.onL3vpnFinished})}).then(function(e){t.onTcpFinished&&t.onTcpFinished(),t.onL3vpnFinished&&t.onL3vpnFinished(),n()})["catch"](function(e){startService({onTcpFinished:t.onTcpFinished,onL3vpnFinished:t.onL3vpnFinished}).then(function(e){n()})["catch"](function(e){u.error(y,"Start service error","ECAgent api retryed and returned error result: "+JSON.stringify(e)),handleStartServiceError(e)})})})}({onBeforeQuery:function(){return new Promise(function(e,n){(function _startTray(){return new Promise(function(e,n){h.isExistEC?function _syncLoginInfo(){return new Promise(function(e,n){if(!f.isWeb()&&S.config.isFirstLogin){var t,r=S.info.loginName,o=SF.vpnInfo.createInstance();r&&((t=o.getLoginInfo()).userName=r,o.saveLoginInfo(t)),e()}else e()})}().then(_startEcTray).then(function(){e()})["catch"](function(e){n({message:tr("系统托盘启动失败"),e:e})}):e()})})().then(t.onBeforeQuery).then(function(){e()})["catch"](function(e){n(e)})})},onTcpFinished:function(){u.info(y,"[timecount] The process of Tcp service started finished"),l.updateRcState(p.APP),t.onTcpFinished&&t.onTcpFinished()},onL3vpnFinished:function(){u.info(y,"[timecount] The process of L3vpn service started finished"),l.updateRcState(p.IP),t.onL3vpnFinished&&t.onL3vpnFinished()},onLogout:t.onLogout}).then(function(){return _syncBaseInfoToClient()}).then(function(){return function _syncInfoForLocalPage(){return new Promise(function(e,n){var t,r,o=SF.setting.getGlobal(KEY_GLOBAL_INIT_GET_INIT_CONFIG_DATA,!1);!h.isExistEC||!S.config.isFirstLogin&&s||S.info.isOnlyWeb?e():(u.assert(o,"Can not get loginAuthConfig data from getGlobal."),r=o.enableAutoLogin,t=o.enableSavePwd,a.syncInfoForLocalPage({info:{enableAutoLogin:r,enableSavePwd:t,svpnID:_getConfigValue("Service.SvpnID",""),hasTcpResource:l.data.hasTcpRc?1:0,hasRemoteApp:l.data.hasRemoteAppRc?1:0,enableHtp:_getConfigValue("Htp.enable",0),enableScache:_getConfigValue("SCache.enable",0),enableWebOpt:_getConfigValue("WebOpt.enable",0),webOptDevice:_getConfigValue("WebOpt.device",0),showRc:S.config.showRc},success:function(){u.debug(y,"step :syncInfoForLocalPage success, sync data for local page"),e()},error:function(e){u.error(y,"step :syncInfoForLocalPage error","error is %s ",e.msg),n({message:"",stack:"sync base information failed"})}}))})}()}).then(function(){u.info(y,"[timecount] last step: start service process success"),t.success()})["catch"](function(e){u.error(y,"catch step: proccess error  "," occur a error in proccess of start service, message is %s stack is %s ",e.message,e.stack),n.error(e)})},goDefault:function(e){var n=this;(function _goDefaultResource(r){return new Promise(function(t,e){S.config.isFirstLogin?o.goDefaultPage().then(function(e){var n;n=0===e,f.isWeb()||!1===e||(u.debug(y,"Hide EC window after open Default resource."),_hideMainWindow()),r&&r(n),n||t(n)}):t()})})(e.onGoDefault).then(function(){return function _swicthShowRcList(){return new Promise(function(e,n){if(f.isWeb()||!S.config.isFirstLogin)return u.debug(y,"In browser or not first login, not switch show state"),void e();S.config.showRc?(u.debug(y,"Not hide EC window, Because showRc of pref-settings or server is false"),e()):(u.debug(y,"Hide EC window, Because showRc of pref-settings or server is true"),_hideMainWindow(),setTimeout(function(){e()},1e3))})}()}).then(function(){u.debug(y,"Call success callback after go default resource"),e.success()})["catch"](function(e){u.error(y,"catch step: proccess error  "," occur a error in proccess of start service, message is %s stack is %s ",e.message,e.stack),n.error(e)})},updateBalanceRes:function(n){n&&SFAPI.updateBalanceRes({rcName:n.name,grpID:n.rc_grp_id,secID:n.selectid,autoID:n.id,success:function(e){u.info(y,"updateBalanceRes: The load balancing update was successful"),n.success(e)},error:function(e){u.error(y,"updateBalanceRes error","error is %s",e.msg),n.error(e)}})},handleResource:function(e,n,t){return o.handleResource(e,n,t)},sf_handle_websvc:function(e){return o.handleWebsvc(e)},error:function(e){u.error(y,"Some error occured, but no function to handle by init.","error is %s",e.msg)}},SF.res=new Res,SF.resConfig=S}(SF);